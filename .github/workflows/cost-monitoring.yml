name: Cost Monitoring

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

env:
  MONTHLY_BUDGET: 15.00 # $15/month for dev environment

jobs:
  cost-estimation:
    name: Cost Estimation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate Infrastructure Cost
        id: cost
        run: |
          # Calculate estimated monthly cost
          HETZNER_COST=9.50  # CPX21 server
          AWS_S3_COST=1.65   # S3 storage
          TOTAL_COST=$(echo "$HETZNER_COST + $AWS_S3_COST" | bc)

          # Calculate percentage of budget
          BUDGET_PERCENTAGE=$(echo "scale=2; ($TOTAL_COST / $MONTHLY_BUDGET) * 100" | bc)

          echo "HETZNER_COST=$HETZNER_COST" >> $GITHUB_OUTPUT
          echo "AWS_S3_COST=$AWS_S3_COST" >> $GITHUB_OUTPUT
          echo "TOTAL_COST=$TOTAL_COST" >> $GITHUB_OUTPUT
          echo "BUDGET_PERCENTAGE=$BUDGET_PERCENTAGE" >> $GITHUB_OUTPUT

          echo "## Cost Estimation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monthly Infrastructure Cost:**" >> $GITHUB_STEP_SUMMARY
          echo "- Hetzner CPX21: â‚¬$HETZNER_COST (\$$HETZNER_COST)" >> $GITHUB_STEP_SUMMARY
          echo "- AWS S3: \$$AWS_S3_COST" >> $GITHUB_STEP_SUMMARY
          echo "- **Total: \$$TOTAL_COST**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Budget Analysis:**" >> $GITHUB_STEP_SUMMARY
          echo "- Monthly Budget: \$$MONTHLY_BUDGET" >> $GITHUB_STEP_SUMMARY
          echo "- Budget Usage: $BUDGET_PERCENTAGE%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cost Savings:**" >> $GITHUB_STEP_SUMMARY
          echo "- vs AWS EKS: 85% savings (\$73 vs \$$TOTAL_COST)" >> $GITHUB_STEP_SUMMARY
          echo "- vs Traditional Cloud: ~80% savings" >> $GITHUB_STEP_SUMMARY

      - name: Check Budget Threshold
        id: budget-check
        run: |
          BUDGET_PERCENTAGE=${{ steps.cost.outputs.BUDGET_PERCENTAGE }}
          THRESHOLD=80

          if (( $(echo "$BUDGET_PERCENTAGE > $THRESHOLD" | bc -l) )); then
            echo "ðŸš¨ Budget alert: $BUDGET_PERCENTAGE% of budget used (threshold: $THRESHOLD%)"
            echo "ALERT=high" >> $GITHUB_OUTPUT
          elif (( $(echo "$BUDGET_PERCENTAGE > 50" | bc -l) )); then
            echo "âš ï¸ Budget warning: $BUDGET_PERCENTAGE% of budget used"
            echo "ALERT=medium" >> $GITHUB_OUTPUT
          else
            echo "âœ… Budget OK: $BUDGET_PERCENTAGE% of budget used"
            echo "ALERT=low" >> $GITHUB_OUTPUT
          fi

      - name: Send Cost Alert
        if: steps.budget-check.outputs.ALERT == 'high' || steps.budget-check.outputs.ALERT == 'medium'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "C12345678" # Replace with your Slack channel ID
          slack-message: |
            Budget Alert for AlphaPulse
            Current Cost: \$${{ steps.cost.outputs.TOTAL_COST }}
            Budget Usage: ${{ steps.cost.outputs.BUDGET_PERCENTAGE }}%
            Monthly Budget: \$${{ env.MONTHLY_BUDGET }}

            Breakdown:
            â€¢ Hetzner: \$${{ steps.cost.outputs.HETZNER_COST }}
            â€¢ AWS S3: \$${{ steps.cost.outputs.AWS_S3_COST }}

            Repository: ${{ github.repository }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  infrastructure-health:
    name: Infrastructure Health Check
    runs-on: ubuntu-latest
    needs: cost-estimation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Health Checks
        run: |
          echo "## Infrastructure Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if Terraform files are valid
          echo "### Terraform Validation" >> $GITHUB_STEP_SUMMARY
          if find infra/terraform -name "*.tf" -type f | grep -q .; then
            echo "âœ… Terraform files found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No Terraform files found" >> $GITHUB_STEP_SUMMARY
          fi

          # Check module structure
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Module Structure" >> $GITHUB_STEP_SUMMARY
          MODULES="networking ec2 s3"
          for module in $MODULES; do
            if [ -d "infra/terraform/modules/$module" ]; then
              echo "âœ… $module module exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $module module missing" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Check environment configurations
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Configurations" >> $GITHUB_STEP_SUMMARY
          ENVIRONMENTS="dev staging prod"
          for env in $ENVIRONMENTS; do
            if [ -d "infra/terraform/environments/$env" ]; then
              echo "âœ… $env environment exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ $env environment missing" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Check CI/CD workflows
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CI/CD Workflows" >> $GITHUB_STEP_SUMMARY
          if [ -f ".github/workflows/terraform-validate.yml" ]; then
            echo "âœ… Terraform validation workflow exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform validation workflow missing" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f ".github/workflows/terraform-deploy.yml" ]; then
            echo "âœ… Terraform deployment workflow exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Terraform deployment workflow missing" >> $GITHUB_STEP_SUMMARY
          fi

  generate-report:
    name: Generate Cost Report
    runs-on: ubuntu-latest
    needs: [cost-estimation, infrastructure-health]

    steps:
      - name: Generate HTML Report
        run: |
          cat > cost-report.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>AlphaPulse Cost Report</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background: #f0f0f0; padding: 20px; border-radius: 5px; }
                  .cost-breakdown { margin: 20px 0; }
                  .cost-item { padding: 10px; border-bottom: 1px solid #ddd; }
                  .alert { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; }
                  .success { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>AlphaPulse Infrastructure Cost Report</h1>
                  <p>Generated: $(date)</p>
              </div>
              
              <div class="cost-breakdown">
                  <h2>Monthly Cost Breakdown</h2>
                  <div class="cost-item">
                      <strong>Hetzner CPX21 Server:</strong> â‚¬9.50 ($9.50)
                  </div>
                  <div class="cost-item">
                      <strong>AWS S3 Storage:</strong> $1.65
                  </div>
                  <div class="cost-item">
                      <strong>Total Monthly Cost:</strong> $11.15
                  </div>
              </div>
              
              <div class="cost-breakdown">
                  <h2>Cost Savings</h2>
                  <div class="success">
                      <strong>85% Savings vs AWS EKS:</strong> $73.00 vs $11.15
                  </div>
                  <p>Traditional AWS EKS deployment would cost approximately $73/month.</p>
              </div>
              
              <div class="cost-breakdown">
                  <h2>Budget Status</h2>
                  <div class="alert">
                      <strong>Monthly Budget:</strong> $15.00
                      <br>
                      <strong>Current Usage:</strong> 74.3%
                      <br>
                      <strong>Status:</strong> Within budget âœ…
                  </div>
              </div>
              
              <div class="cost-breakdown">
                  <h2>Infrastructure Details</h2>
                  <ul>
                      <li><strong>Server:</strong> Hetzner CPX21 (3 vCPU, 4GB RAM, 80GB SSD)</li>
                      <li><strong>Storage:</strong> AWS S3 with lifecycle policies</li>
                      <li><strong>Services:</strong> Mage.ai, MLflow, MinIO, PostgreSQL</li>
                      <li><strong>Deployment:</strong> Docker Compose on Hetzner</li>
                  </ul>
              </div>
          </body>
          </html>
          EOF

          echo "Cost report generated: cost-report.html"

      - name: Upload Cost Report
        uses: actions/upload-artifact@v4
        with:
          name: cost-report
          path: cost-report.html
