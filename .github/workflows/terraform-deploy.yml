name: Terraform Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: "Terraform action"
        required: true
        default: "apply"
        type: choice
        options:
          - plan
          - apply
          - destroy
      auto_approve:
        description: "Auto-approve apply/destroy"
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: 1.5.0
  AWS_REGION: us-east-1

jobs:
  terraform-deploy:
    name: Terraform Deploy - ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    defaults:
      run:
        working-directory: infra/terraform/environments/${{ github.event.inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure OCI Credentials
        run: |
          echo "TF_VAR_tenancy_ocid=${{ secrets.OCI_TENANCY_OCID }}" >> $GITHUB_ENV
          echo "TF_VAR_user_ocid=${{ secrets.OCI_USER_OCID }}" >> $GITHUB_ENV
          echo "TF_VAR_fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> $GITHUB_ENV
          echo "TF_VAR_private_key=${{ secrets.OCI_PRIVATE_KEY }}" >> $GITHUB_ENV
          echo "TF_VAR_region=${{ secrets.OCI_REGION }}" >> $GITHUB_ENV
          echo "TF_VAR_compartment_id=${{ secrets.OCI_COMPARTMENT_ID }}" >> $GITHUB_ENV

      - name: Terraform Init
        id: init
        run: terraform init
        env:
          TF_CLI_ARGS: "-no-color"

      - name: Terraform Plan
        id: plan
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        run: terraform plan -input=false -out=tfplan
        env:
          TF_CLI_ARGS: "-no-color"

      - name: Upload Plan Artifact
        if: github.event.inputs.action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment }}
          path: infra/terraform/environments/${{ github.event.inputs.environment }}/tfplan

      - name: Terraform Apply
        id: apply
        if: github.event.inputs.action == 'apply'
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
            terraform apply -auto-approve tfplan
          else
            terraform apply tfplan
          fi
        env:
          TF_CLI_ARGS: "-no-color"

      - name: Terraform Destroy
        id: destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
            terraform destroy -auto-approve
          else
            terraform destroy
          fi
        env:
          TF_CLI_ARGS: "-no-color"

      - name: Get Terraform Outputs
        id: outputs
        if: github.event.inputs.action == 'apply'
        run: |
          terraform output -json > outputs.json
          echo "OUTPUTS=$(cat outputs.json | jq -c .)" >> $GITHUB_ENV

      - name: Upload Outputs Artifact
        if: github.event.inputs.action == 'apply'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ github.event.inputs.environment }}
          path: infra/terraform/environments/${{ github.event.inputs.environment }}/outputs.json

      - name: Create Deployment Summary
        if: always()
        run: |
          echo "# Terraform Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.action }}" = "apply" ] && [ -f outputs.json ]; then
            echo "## Deployment Outputs" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat outputs.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: terraform-deploy
    if: always()

    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.25.0
        if: github.event.inputs.environment == 'prod' || github.event.inputs.action == 'destroy'
        with:
          channel-id: "C12345678" # Replace with your Slack channel ID
          slack-message: |
            Terraform deployment ${{ job.status }} for ${{ github.event.inputs.environment }} environment
            Action: ${{ github.event.inputs.action }}
            Repository: ${{ github.repository }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Send Cost Alert
        if: github.event.inputs.action == 'apply'
        run: |
          echo "Cost estimation for ${{ github.event.inputs.environment }} deployment:"
          echo "- Oracle Cloud (ARM64 A1): $0.00/month (Always Free Tier)"
          echo "- Total: $0.00/month"
          echo "- Savings: 100% vs AWS EKS ($73/month)"
